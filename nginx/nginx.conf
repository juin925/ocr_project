worker_processes auto;
events { worker_connections 1024; }

http {
  # --------------------------
  # Flask App Cluster (LB ëŒ€ìƒ)
  # --------------------------
  upstream flask_cluster {
    server ocr_app1:5000;
    server ocr_app2:5000;
    server ocr_app3:5000;
  }

  # --------------------------
  # HTTP (80) â†’ HTTPS ë¦¬ë‹¤ì´ë ‰íŠ¸
  # --------------------------
  server {
    listen 80;
    server_name juin.kakaolab.cloud;
    return 301 https://$host$request_uri;
  }

  # --------------------------
  # HTTPS (443) Reverse Proxy
  # --------------------------
  server {
    listen 443 ssl;
    server_name juin.kakaolab.cloud;

    # ğŸ” SSL ì¸ì¦ì„œ ê²½ë¡œ (Let's Encrypt ì˜ˆì‹œ)
    ssl_certificate     /etc/letsencrypt/live/juin.kakaolab.cloud/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/juin.kakaolab.cloud/privkey.pem;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers HIGH:!aNULL:!MD5;

    location / {
      proxy_pass http://flask_cluster;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      # ì¶”ê°€ì ìœ¼ë¡œ ì‘ë‹µ í—¤ë” í‘œì‹œ (í…ŒìŠ¤íŠ¸ìš©)
      add_header X-Upstream $upstream_addr;
    }

    # ì •ì íŒŒì¼ ìºì‹± ìµœì í™” (ì„ íƒ)
    location ~* \.(jpg|jpeg|png|gif|css|js|ico|webp)$ {
      expires 7d;
      access_log off;
    }
  }
}
